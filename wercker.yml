box: wercker-labs/docker
build:
  steps:
    - script:
        name: Build the container
        code: |
          docker build -t quay.io/democracyworks/immutant-balancer .
    - script:
        name: Login to quay.io
        hide-from-log: true
        code: |
          echo $QUAY_DOCKERCFG > $HOME/.dockercfg
    - script:
        name: Push the container to the public registry
        code: |
          docker push quay.io/democracyworks/immutant-balancer
deploy:
  steps:
    - add-to-known_hosts:
        hostname: vpc-gw.turbovote.org
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: write key
        filename: $PRIVATEKEY_PATH
        content: $DEPLOY_PRIVATE_KEY
        overwrite: true
        hide-from-log: true
    - script:
        name: setup ssh tunnels to docker hosts
        code: |
          ssh -i $PRIVATEKEY_PATH ec2-user@vpc-gw.turbovote.org -L2222:docker1-int.turbovote.org:22 -f -N
          ssh -i $PRIVATEKEY_PATH ec2-user@vpc-gw.turbovote.org -L2223:docker2-int.turbovote.org:22 -f -N
    - script:
        name: copy quay.io credentials to Docker hosts
        code: |
          echo $QUAY_DOCKERCFG > $HOME/.dockercfg
          scp -i $PRIVATEKEY_PATH -o "StrictHostKeyChecking no" -P 2222 $HOME/.dockercfg deploy@localhost:.dockercfg
          scp -i $PRIVATEKEY_PATH -o "StrictHostKeyChecking no" -P 2223 $HOME/.dockercfg deploy@localhost:.dockercfg
    - script:
        name: get IDs of existing containers
        code: |
          export DOCKER1_CONTAINER=$(ssh -i $PRIVATEKEY_PATH -o "StrictHostKeyChecking no" -p 2222 deploy@localhost "docker ps | grep democracyworks/immutant-balancer | awk '{print \$1}'")
          export DOCKER2_CONTAINER=$(ssh -i $PRIVATEKEY_PATH -o "StrictHostKeyChecking no" -p 2223 deploy@localhost "docker ps | grep democracyworks/immutant-balancer | awk '{print \$1}'")
    - script:
        name: restart containers
        code: |
          if [ -n "$DOCKER1_CONTAINER" ]; then ssh -i $PRIVATEKEY_PATH -o "StrictHostKeyChecking no" -p 2222 deploy@localhost "docker stop $DOCKER1_CONTAINER"; fi
          ssh -i $PRIVATEKEY_PATH -o "StrictHostKeyChecking no" -p 2222 deploy@localhost "docker pull quay.io/democracyworks/immutant-balancer && docker run -d -p 60080:80 quay.io/democracyworks/immutant-balancer"
          sleep 15 # make sure new containers are spun up and serving traffic
          if [ -n "$DOCKER2_CONTAINER" ]; then ssh -i $PRIVATEKEY_PATH -o "StrictHostKeyChecking no" -p 2223 deploy@localhost "docker stop $DOCKER2_CONTAINER"; fi
          ssh -i $PRIVATEKEY_PATH -o "StrictHostKeyChecking no" -p 2223 deploy@localhost "docker pull quay.io/democracyworks/immutant-balancer && docker run -d -p 60080:80 quay.io/democracyworks/immutant-balancer"
