{
  "services": {
    "wildfly": {
      "discovery": {
        "method": "docker",
        "servers": [{
          "name": "coreos-2",
          "host": "10.36.126.92",
          "port": 2375
        }],
        "image_name": "quay.io/democracyworks/wildfly",
        "container_port": 8080,
        "check_interval": 5
      },
      "haproxy": {
        "port": 8081,
        "server_options": "check inter 2s rise 3 fall 2",
        "listen": [
          "mode http"
        ]
      }
    },
    "turbovote": {
      "discovery": {
        "method": "docker",
        "servers": [{
          "name": "coreos-2",
          "host": "10.36.126.150",
          "port": 2375
        }],
        "image_name": "quay.io/democracyworks/turbovote",
        "container_port": 3000,
        "check_interval": 5
      },
      "haproxy": {
        "port": 8082,
        "server_options": "check inter 2s rise 3 fall 2",
        "listen": [
          "mode http"
        ]
      }
    }
  },
  "haproxy": {
    "reload_command": "haproxy -f /etc/haproxy/haproxy.cfg -p /var/run/haproxy.pid -sf $(cat /var/run/haproxy.pid)",
    "config_file_path": "/etc/haproxy/haproxy.cfg",
    "socket_file_path": "/var/haproxy/stats.sock",
    "do_writes": true,
    "do_reloads": true,
    "do_socket": false,
    "global": [
      "daemon",
      "user haproxy",
      "group haproxy",
      "maxconn 4096",
      "ulimit-n 8207",
      "log     127.0.0.1 local0",
      "log     127.0.0.1 local1 notice",
      "stats   socket /var/haproxy/stats.sock mode 666 level admin"
    ],
    "defaults": [
      "log      global",
      "option   dontlognull",
      "maxconn  2000",
      "retries  3",
      "timeout  connect 5s",
      "timeout  client  1m",
      "timeout  server  1m",
      "option   redispatch",
      "balance  roundrobin"
    ],
    "extra_sections": {
      "listen stats": [
        "mode http",
        "bind *:8080",
        "log global",
        "maxconn 10",
        "stats enable",
        "stats refresh 30s",
        "stats show-node",
        "stats uri /stats"
      ],
      "frontend http-in": [
        "mode http",
        "bind *:80",
        "http-response add-header X-Via %[env(HOSTNAME)]",
        "capture request header Host len 64",
        "acl is_ballot_scout hdr_end(host) -i ballotscout.org",
        "use_backend ballot_scout if is_ballot_scout",
        "acl is_address hdr_end(host) -i api-int.turbovote.org",
        "use_backend address if is_address",
        "acl is_sendgrid_monitor hdr_end(host) -i sendgrid-monitor.democracy.works",
        "use_backend sendgrid_monitor if is_sendgrid_monitor",
        "acl is_turbovote_staging hdr_end(host) -i turbovote.net",
        "use_backend turbovote_staging if is_turbovote_staging",
        "acl is_online_voter_reg_api hdr_end(host) -i online-voter-reg-api.turbovote.org",
        "use_backend online_voter_reg_api if is_online_voter_reg_api",
        "acl is_api_server hdr_end(host) -i api.turbovote.org",
        "acl is_user_api url_beg -i /users",
        "use_backend user_api if is_api_server is_user_api",
        "acl is_election_notification_api url_beg -i /election-notifications",
        "use_backend election_notification_api if is_api_server is_election_notification_api",
        "acl is_voter_registration_api url_beg -i /voter-registration",
        "use_backend voter_registration_api if is_api_server is_voter_registration_api",
        "acl is_election_authority_api url_beg -i /election-authorities",
        "use_backend election_authority_api if is_api_server is_election_authority_api",
        "acl is_voting_method_api url_beg -i /voting-methods",
        "use_backend voting_method_api if is_api_server is_voting_method_api",
        "acl is_vote_by_mail_api url_beg -i /vote-by-mail",
        "use_backend vote_by_mail_api if is_api_server is_vote_by_mail_api",
        "acl is_partners_api url_beg -i /partners",
        "use_backend partners_api if is_api_server is_partners_api",
        "acl is_election_api url_beg -i /elections",
        "use_backend election_api if is_api_server is_election_api",
        "acl is_election_mail_api url_beg -i /election-mail",
        "use_backend election_mail_api if is_api_server is_election_mail_api",
        "acl is_turbovote_admin_api url_beg -i /turbovote-admin",
        "use_backend turbovote_admin_api if is_api_server is_turbovote_admin_api"
      ],
      "backend ballot_scout": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ (.+)    \\1\\ /ballot-scout\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend address": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ (.+)    \\1\\ /address-works\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend user_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ /users(.+)    \\1\\ /user-http-api\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend election_notification_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ /election-notifications(.+)    \\1\\ /election-notification-http-api\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend voter_registration_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ /voter-registration(.+)    \\1\\ /voter-registration-http-api\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend election_authority_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ /election-authorities(.+)  \\1\\ /election-authority-http-api\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend voting_method_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ /voting-methods(.+)  \\1\\ /voting-method-http-api\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend vote_by_mail_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ /vote-by-mail(.+)  \\1\\ /vote-by-mail-http-api\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend partners_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ /partners(.+)  \\1\\ /partner-http-api\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend sendgrid_monitor": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ (.+)    \\1\\ /sendgrid-monitor\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend turbovote_staging": [
        "mode http",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8082 maxconn 32"
      ],
      "backend online_voter_reg_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ (.+)    \\1\\ /online-voter-reg-api\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend election_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ /elections(.+)    \\1\\ /election-http-api\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend election_mail_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ /election-mail(.+)    \\1\\ /election-mail-http-api\\2",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ],
      "backend turbovote_admin_api": [
        "mode http",
        "reqrep ^([^\\ ]*)\\ /turbovote-admin(.+)    \\1\\ /turbovote-admin-http-api\\2",
        "timeout  server  10m",
        "balance roundrobin",
        "option httpclose",
        "option forwardfor",
        "server local localhost:8081 maxconn 32"
      ]
    }
  }
}
